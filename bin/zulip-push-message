#!/bin/bash

# shellcheck disable=SC1090
source "$(dirname "$(dirname "$(realpath "${0}")")")/.privacy/zulip.cfg"

TEXT=''
while IFS='' read -r LINE; do
    TEXT+=${LINE}
    TEXT+=$'\n'
done

TEXT=$'```text\n'"${TEXT}"$'```\n'

curl --fail --location --silent --show-error --request POST \
    --data-urlencode 'content='"${TEXT}" \
    --data 'subject=notice' \
    --data 'to=no-ip' \
    --data 'type=stream' \
    --user "${BOT_EMAIL_ADDRESS}:${BOT_API_KEY}" \
    'https://'"${ORGANIZATION}"'.zulipchat.com/api/v1/messages' \
    | python3 -c '
import json
import sys

response = json.load(sys.stdin)

print(response["result"])
        '
