#!/bin/bash

set -o errexit
set -o nounset
set -o pipefail

# shellcheck disable=SC1090
source "$(dirname "$(dirname "$(realpath "${0}")")")/.privacy/namecheap.cfg"

sleep 15

CURRENCY_RATE=$(curl --fail --location --silent --show-error --request GET "https://free.currencyconverterapi.com/api/v6/convert?q=USD_CNY&compact=ultra&apiKey=${CURRENCY_CONVERTER_API_KEY}" | awk --field-separator '[{:}]' '{ print $3 }')
PUBLIC_IP_ADDRESS=$(dig myip.opendns.com @208.67.222.222 a +short)
REQUEST_API_METHOD='namecheap.users.getPricing'

if [ -z "${CURRENCY_RATE}" ] || [ -z "${PUBLIC_IP_ADDRESS}" ]; then
    exit
fi

for i in ${WATCH_LIST}; do
    sleep 1

    xmllint --xpath '//*[local-name()="Price"]/@*[name()="YourPrice"]' \
        <(
        curl --fail --location --silent --show-error --request GET \
            --get \
            --data ApiKey="${API_KEY}" \
            --data ApiUser="${API_USER}" \
            --data ClientIp="${PUBLIC_IP_ADDRESS}" \
            --data UserName="${USER_NAME}" \
            --data Command=${REQUEST_API_METHOD} \
            --data ActionName=RENEW \
            --data ProductName="${i}" \
            --data ProductType=DOMAIN \
            'https://api.namecheap.com/xml.response'
        ) \
        | xargs --max-args 1 --no-run-if-empty \
        | awk --assign suffix="${i}" --assign rate="${CURRENCY_RATE}" --field-separator = 'BEGIN { printf suffix }; { printf ",%.2f", $2 * rate }; END { printf "\n" }'
done \
    | column --separator , --table --table-columns "$(echo SUFFIX {1..10} | tr ' ' ,)" --table-right "$(echo {1..10} | tr ' ' ,)"
